/ 2022.09.07

### 경쟁 상태란?

공유 자원에 대해 여러 프로세스(쓰레드)가 동시에 접근할 때, 결과값에 영향을 줄 수 있는 상태

경쟁 상태시 동시 접근 시 자료의 일관성을 해칠 수 있다는 문제가 발생함

### **WWDC에서 나온 Example**

아래 코드는 글로벌 쓰레드에서 어떤 배열에 요소를 추가하는 작업을 비동기적으로 처리하게 설정한 것이다.

Granpa와 Cub이라는 문자열을 sleepingBears에 넣는 작업.

<img width="856" alt="image" src="https://user-images.githubusercontent.com/103009135/188779625-77f9a139-863f-4b3b-8aa4-e063e1d0cbea.png">

<img width="832" alt="image" src="https://user-images.githubusercontent.com/103009135/188779581-3ba9975e-4d36-4fa7-a339-df3a2f70f4d1.png">


sleepingBears라는 배열에 접근하는데, 글로벌 쓰레드 두개가 경쟁하는 상황이다. 누가 이길지 모르니, 추가된 요소의 순서가 달라져 다른 배열이 되는 모습을 볼 수 있다.

이러면 참 골 때리는 상황이 연출되겟죠?? 

### **[#](https://gyoogle.dev/blog/computer-science/operating-system/Race%20Condition.html#race-condition%E1%84%8B%E1%85%B5-%E1%84%87%E1%85%A1%E1%86%AF%E1%84%89%E1%85%A2%E1%86%BC%E1%84%92%E1%85%A1%E1%84%82%E1%85%B3%E1%86%AB-%E1%84%80%E1%85%A7%E1%86%BC%E1%84%8B%E1%85%AE)Race Condition이 발생하는 경우**

자원에 동시에 접근할 때가 언제있을까? 를 생각하시고 보면 이해하시기 수월합니다!

1. **[#](https://gyoogle.dev/blog/computer-science/operating-system/Race%20Condition.html#%E1%84%8F%E1%85%A5%E1%84%82%E1%85%A5%E1%86%AF-%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%8B%E1%85%B3%E1%86%AF-%E1%84%89%E1%85%AE%E1%84%92%E1%85%A2%E1%86%BC%E1%84%92%E1%85%A1%E1%84%82%E1%85%B3%E1%86%AB-%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%8B%E1%85%A6-%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%90%E1%85%A5%E1%84%85%E1%85%A5%E1%86%B8%E1%84%90%E1%85%B3-%E1%84%87%E1%85%A1%E1%86%AF%E1%84%89%E1%85%A2%E1%86%BC)커널 작업을 수행하는 중에 인터럽트 발생할 때 !!** 
    - 문제점 : 커널모드에서 데이터를 로드하여 작업을 수행하다가 인터럽트가 발생하여 같은 데이터를 조작하는 경우
    - 해결법 : 커널모드에서 작업을 수행하는 동안, 인터럽트를 disable 시켜 CPU 제어권을 가져가지 못하도록 한다.
    
    ** 커널모드와 유저모드란?
    
    - **정의**
    “커널모드와 유저모드는 프로그램이 운행되는 방식”입니다. 
    일반적으로 사용자가 프로그램을 쓴다면 CPU는 유저모드에서 수행되고 필요에 따라 커널모드가 되었다가 다시 유저모드로 돌아오기를 반복합니다.
    
    **유저모드는 유저가 프로그램의 자원에 함부로 침범하지 못하는 운영 방식이며 커널모드는 드라이버, 메모리, CPU등 모든 자원에 접근, 명령을 내릴 수 있는 운영 방식입니다.** 
    
     “인터럽트가 발생하거나 시스템 콜을 호출하게 되면” 운영체제는 유저모드에서 커널 모드로 전환하게 됩니다.
    - **목적**
    두 모드를 분리해서 왔다갔다 하는이유는 I/O 장치를 보호하기 위함입니다. 유저가 드라이버나 메모리에 있는 데이터를 삭제하거나 조작하는 악성 프로그램을 다운받더라도, 그 프로그램이 유저모드에서 수행되기 때문에 CPU는 I/O 관련 데이터를 조작하는 명령어는 자체적으로 판단해서 수행시키지 않는다고 합니다.
    
    ** 시스템콜과 인터럽트?
    
    인터럽트란? :
    운영 체제에서 컴퓨터에 예기치 않은 일이 발생하더라도 작동이 중단되지 않고 계속적으로 업무 처리를 할 수 있도록 해 주는 기능입니다.
    예를 들어보자면, 전원이 갑자기 나가거나, 데이터 전달 과정에서 오류가 나거나.. 연산을 하다가 0으로 나눈다거나.. 하는 그런 상황입니다. 참고로 인터럽트가 발생하면 이를 처리하기 위해 즉각적으로 커널모드에 들어갑니다.
    
    **시스템콜?:**
    
    시스템 호출(system call)은 운영 체제의 커널이 제공하는 서비스에 대해, 응용 프로그램의 요청에 따라 커널에 접근하기 위한 인터페이스입니다.
    
    대부분 프로그램이 유저 모드에서 수행되지만 중요한 정보를 가져와야할때 커널의 도움이 필요합니다. 그래서 이 때 시스템 콜이라는 인터페이스를 이용해서 커널이 제공하는 함수나 데이터 등을 프로그램에 가져올 수 있는 것이지요
    예를 들어, 파일을 읽고 쓰고 하는 작업, 스레드 배정, 프로세스 끼리 통신하는 작업 등에 시스템 콜이 필요하다고 합니다.
    
2. **[#](https://gyoogle.dev/blog/computer-science/operating-system/Race%20Condition.html#%E1%84%91%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%A6%E1%84%89%E1%85%B3%E1%84%80%E1%85%A1-system-call-%E1%84%8B%E1%85%B3%E1%86%AF-%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7-%E1%84%8F%E1%85%A5%E1%84%82%E1%85%A5%E1%86%AF-%E1%84%86%E1%85%A9%E1%84%83%E1%85%B3%E1%84%85%E1%85%A9-%E1%84%8C%E1%85%B5%E1%86%AB%E1%84%8B%E1%85%B5%E1%86%B8%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7-%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%8B%E1%85%B3%E1%86%AF-%E1%84%89%E1%85%AE%E1%84%92%E1%85%A2%E1%86%BC%E1%84%92%E1%85%A1%E1%84%82%E1%85%B3%E1%86%AB-%E1%84%83%E1%85%A9%E1%84%8C%E1%85%AE%E1%86%BC-%E1%84%86%E1%85%AE%E1%86%AB%E1%84%86%E1%85%A2%E1%86%A8-%E1%84%80%E1%85%AD%E1%84%92%E1%85%AA%E1%86%AB%E1%84%8B%E1%85%B5-%E1%84%87%E1%85%A1%E1%86%AF%E1%84%89%E1%85%A2%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AF-%E1%84%84%E1%85%A2)프로세스가 'System Call'을 하여 커널 모드로 진입하여 작업을 수행하는 도중 문맥 교환(context switching)이 발생할 때!**
    - 문제점 : 프로세스1이 커널모드에서 데이터를 조작하는 도중, 시간이 초과되어 CPU 제어권이 프로세스2로 넘어가 같은 데이터를 조작하는 경우 ( 프로세스2가 작업에 반영되지 않음 )
    - 해결법 : 프로세스가 커널모드에서 작업을 하는 경우 시간이 초과되어도 CPU 제어권이 다른 프로세스에게 넘어가지 않도록 함
3. **[#](https://gyoogle.dev/blog/computer-science/operating-system/Race%20Condition.html#%E1%84%86%E1%85%A5%E1%86%AF%E1%84%90%E1%85%B5-%E1%84%91%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%A6%E1%84%89%E1%85%A5-%E1%84%92%E1%85%AA%E1%86%AB%E1%84%80%E1%85%A7%E1%86%BC%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5-%E1%84%80%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%B2-%E1%84%86%E1%85%A6%E1%84%86%E1%85%A9%E1%84%85%E1%85%B5-%E1%84%82%E1%85%A2%E1%84%8B%E1%85%B4-%E1%84%8F%E1%85%A5%E1%84%82%E1%85%A5%E1%86%AF-%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%E1%84%8B%E1%85%A6-%E1%84%8C%E1%85%A5%E1%86%B8%E1%84%80%E1%85%B3%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AF-%E1%84%84%E1%85%A2)멀티 프로세서 환경에서 공유 메모리 내의 커널 데이터에 접근할 때**
    - 문제점 : 멀티 프로세서 환경에서 2개의 CPU가 동시에 커널 내부의 공유 데이터에 접근하여 조작하는 경우
    - 해결법 : 커널 내부에 있는 각 공유 데이터에 접근할 때마다, 그 데이터에 대한 lock/unlock을 하는 방법이 있다.

## Additional Reference

[https://sujinnaljin.medium.com/ios-차근차근-시작하는-gcd-12-c06b599fe7f5](https://sujinnaljin.medium.com/ios-%EC%B0%A8%EA%B7%BC%EC%B0%A8%EA%B7%BC-%EC%8B%9C%EC%9E%91%ED%95%98%EB%8A%94-gcd-12-c06b599fe7f5) (경쟁 상태) 

[https://dev-workplace.tistory.com/10](https://dev-workplace.tistory.com/10) (디스패치 큐란?)

[https://developer.apple.com/documentation/dispatch/dispatchqueue](https://developer.apple.com/documentation/dispatch/dispatchqueue) (Apple Documentation)
